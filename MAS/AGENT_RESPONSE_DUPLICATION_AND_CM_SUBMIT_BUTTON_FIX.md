# Agent Response Duplication & CM Submit Button Fix
Changes timestamp: 12.08.2025

# Issue 1: Agent Response Duplication
## Issue Identified

Upon exiting the user response text area after finishing writing, the last response from the AI agent gets rewritten.

## Root Cause Analysis

1. **Application state change**: Event listener connected to the text area responds to the user interaction by reruning the page script.
2. **New response generation upon reruns**: Agent response is getting generated on each page script rerun, even when the response was already printed previously.
3. **Duplicated log entries**: Session logs contain entries of event type "agent_response" with the same values for the `round_number` and `conversation_turn`, but different values for the `agent_response` field, identifying there is an issue with message duplication.

## Fixes Implemented

### Saving first successfully displayed response

First message that had been displayed to the user (either generated by the agent or the default fallback message) will now be saved in the session state (`st.session_state.agent_msg`). Upon rerunning the page script, the stored message will be shown. Stored message will be resetted after clicking either on the `Finish Round` or `Continue Conversation` button.

## Testing Results

After implementing this fix:

1. **No response override**: Agent response is not getting updated on the application page.
2. **No response duplication**: Log files contain only one message entry for each conversation turn.
3. **Computation and latency impovements**: Due to responses not getting processed on each update of the user input field, conversation flow was visibly impoved.


---

# Issue 2: CM Submit Button 

## Issue Identified

After clicking on the Submit button for the conceptmap component, an info message is being displayed on it's place, informing user that the concept map is getting submitted, even when the submission process is already finished.

## Root Cause Analysis

1. **Interaction flow issues**: Info box displayed instead of the submit button should disappear after the followup window was opened, indicating that the map was successfully parsed and analyzed on the backend.

## Fixes Implemented

### Changing the render_cm_submit_button() function:

Small adjustments were made in the `app.py:render_cm_submit_button()`function. After clicking on the Submit button, the button becomes disabled, but does not disappear, indicating to the user that their request is getting processed. After the followup frame gets rendered, this part of the page will disappear until the next round.

```python
def render_cm_submit_button():
    """Render concept map submit button."""
    st.markdown("---")  # Add a separator
    
    if st.session_state.followup:
        st.success("Concept map was submitted successfully!")
        return

    # Make the submit button more prominent
    st.markdown("### Submit Your Concept Map")
    
    _, col2, _ = st.columns([1, 2, 1])
    with col2:
        if st.button("ðŸš€ Submit Concept Map", type='primary', use_container_width=True, disabled=st.session_state.submit_request):
            st.session_state.submit_request = True
            st.rerun() 
```

## Testing Results 

1. **Proper interaction flow**: Submit CM button section is being now properly displayed in the application, without distracting from the conversation with the agent.
